<!DOCTYPE html>
<html>
<head>
    <title>Audio Recorder</title>
    <style>
        /* 全体の背景色を黒に設定 */
        /* 全体の背景色を黒に設定 */
        body {
            background-color: black;
            color: white; /* 文字色を白に設定 */
            margin: 0;
            padding: 0;
        }

        /* センタリングのためのコンテナ */
        .container {
            position: absolute;
            top: 10%; /* ページの上から10%の位置に配置 */
            left: 50%; /* ページの左から50%の位置に配置 */
            transform: translate(-50%, -10%); /* 位置調整 */
        }

        /* ボタンのスタイル設定 */
        button {
            background-color: #4CAF50; /* ボタンの背景色 */
            border: none;
            color: white; /* 文字色 */
            padding: 15px 32px; /* 上下15px、左右32pxの余白を設定 */
            text-align: center;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }

        /* テキストのスタイル設定 */
        #recordingStatus {
            font-size: 18px;
        }
        /* transcriptionOutputの文字サイズを30ptに設定 */
        #transcriptionOutput {
            font-size: 30pt;
        }
    </style>
</head>
<body>
    <div class="container"> <!-- センタリングのためのコンテナ -->
        <button onclick="startRecording()">Start Recording</button>
        <button onclick="stopRecording()">Stop Recording</button>
        <button onclick="teachWord()">Teach Word</button>
        <button onclick="saveToCsv()">Save to CSV</button>
        <span id="recordingStatus"></span>
        <div id="transcriptionOutput"></div>
        <div id="teachWordOutput"></div> <!-- 新しい出力領域 -->
    </div>
    <script>
        var mediaRecorder;
        var audioChunks = [];

        async function startRecording() {
            document.getElementById("recordingStatus").innerText = "[now recording...]"; // 追加された行
            document.getElementById("transcriptionOutput").innerText = "";  // 追加された行

            audioChunks = [];  // 録音を再度開始する前に、audioChunksをクリア
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                document.getElementById("recordingStatus").innerText = ""; // 追加された行

                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                let formData = new FormData();
                formData.append("audio", audioBlob, "output.wav");

                let response = await fetch('/transcribe', {
                    method: 'POST',
                    body: formData
                });

                let data = await response.json();
                console.log(data);
                document.getElementById("transcriptionOutput").innerText = data.transcription.text;  // 追加した部分 # 出力形式が.text となる
            };

            mediaRecorder.start();
        }

        function stopRecording() {
            mediaRecorder.stop();
        }

        async function teachWord() {
            let word = document.getElementById("transcriptionOutput").innerText;
            let response = await fetch('/teach_word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({word: word}),
            });

            let data = await response.json();
            document.getElementById("teachWordOutput").innerText = data.content; // 結果を表示
        }
        // 新しい関数
    async function saveToCsv() {
        let text = document.getElementById("transcriptionOutput").innerText;
        let response = await fetch('/save_to_csv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({text: text}),
        });

        let data = await response.json();

    // サーバからのレスポンスに基づいて、メッセージを表示
    if (data.message === 'Saved to CSV in data folder') {
        // ここに表示する要素を作成または選択して、メッセージを設定します。
        // 例として、新しくdiv要素を作成して、その中にメッセージを表示する場合：
        let messageDiv = document.createElement('div');
        messageDiv.innerText = 'Data is added to the file';
        document.body.appendChild(messageDiv);
    }
    }
    </script>
</body>
</html>

